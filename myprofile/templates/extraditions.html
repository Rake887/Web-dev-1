<!DOCTYPE html>
<html lang="ru">
{% load static %}    

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inter Cargo - оформление выдачи</title>
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>tailwind.config={theme:{extend:{colors:{primary:'#e53e3e',secondary:'#4a5568'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
    <script src="{% static 'scripts/core.js' %}"></script>
    <link rel="stylesheet" href="{% static 'styles/css2.css' %}"/>
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}"/>
    <link rel="stylesheet" href="{% static 'styles/remixicon/remixicon.css' %}"/>
</head>
<body class="bg-gray-50 min-h-screen">
{% include 'includes/header.html' %}

{% block content %}
<div class="flex min-h-screen">
    {% include 'includes/sidebar.html' %}

    <main class="w-full px-6 py-8 mx-auto">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                    <i class="ri-archive-line text-primary text-2xl"></i>
                    Оформление выдачи
                </h1>
                <p class="text-sm text-gray-500">Оператор: <strong>{{ request.user.username }}</strong></p>
            </div>

            <!-- Сообщения Django -->
            {% if messages %}
            <div class="space-y-2 mb-6">
                {% for message in messages %}
                <div class="flex items-start gap-3
                    {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800
                    {% elif message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800
                    {% elif message.tags == 'warning' %}bg-yellow-50 border border-yellow-200 text-yellow-800
                    {% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}
                    px-4 py-3 rounded-lg">
                    <span class="text-xl">
                        {% if message.tags == 'error' %}<i class="ri-alert-line"></i>
                        {% elif message.tags == 'success' %}<i class="ri-check-line"></i>
                        {% elif message.tags == 'warning' %}<i class="ri-error-warning-line"></i>
                        {% else %}<i class="ri-information-line"></i>{% endif %}
                    </span>
                    <div class="text-sm leading-relaxed">{{ message }}</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Форма -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm">
                    <form id="extraditionForm" method="post" class="space-y-6">
                        {% csrf_token %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="pickup_point" class="block font-medium mb-2">Пункт выдачи <span class="text-sm text-gray-400">(обязательно)</span>:</label>
                                <input type="text" name="pickup_point" id="pickup_point" required
                                    class="w-full border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary"
                                    placeholder="Например: Центральный склад, Алматы">
                            </div>

                            <div>
                                <label for="receipt_id" class="block font-medium mb-2">ID чека (если есть):</label>
                                <input type="text" name="receipt_id" id="receipt_id"
                                    class="w-full border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary"
                                    placeholder="Например: 15">
                            </div>
                        </div>

                        <div>
                            <label for="track_codes" class="block font-medium mb-2">Трек-коды (по одному в строке)</label>

                            <div class="relative">
                                <textarea name="track_codes" id="track_codes" rows="7"
                                    class="w-full border border-gray-200 rounded-lg p-3 pr-40 resize-y focus:outline-none focus:ring-2 focus:ring-primary"
                                    placeholder="Вставьте трек-коды, по одному на строку"></textarea>

                                <!-- Файловая загрузка -->
                                <label for="fileInput" class="absolute right-2 top-2 inline-flex items-center gap-2 bg-gray-100 border border-gray-200 rounded-lg px-3 py-1 cursor-pointer hover:bg-gray-200">
                                    <i class="ri-upload-cloud-line"></i> Загрузить файл
                                </label>
                                <input id="fileInput" type="file" accept=".txt,.csv" class="hidden" />
                            </div>

                            <p class="mt-2 text-sm text-gray-500">Поддерживаемые форматы: .txt, .csv — один трек на строку.</p>
                        </div>

                        <div>
                            <label for="comment" class="block font-medium mb-2">Комментарий (необязательно)</label>
                            <textarea name="comment" id="comment" rows="3"
                                class="w-full border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary"
                                placeholder="Комментарий для записи"></textarea>
                        </div>

                        <div class="flex items-center gap-3">
                            <button id="openConfirmBtn" type="button" class="inline-flex items-center gap-2 bg-primary text-white px-5 py-2 rounded-button hover:bg-red-600 transition">
                                <i class="ri-check-line"></i> Оформить выдачу
                            </button>

                            <button type="button" id="clearBtn" class="inline-flex items-center gap-2 border border-gray-200 px-4 py-2 rounded-lg hover:bg-gray-50">
                                <i class="ri-delete-bin-line"></i> Очистить поля
                            </button>

                            <div class="ml-auto text-sm text-gray-600">
                                Треков: <span id="codesCount" class="font-medium">0</span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Превью и помощь -->
                <aside class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-lg font-semibold mb-3">Превью трек-кодов</h2>

                    <div id="previewEmpty" class="text-sm text-gray-500">
                        Вставьте трек-коды в поле слева — превью появится автоматически.
                    </div>

                    <div id="previewList" class="space-y-2 max-h-72 overflow-auto hidden">
                        <!-- Элементы будут добавляться JS -->
                    </div>

                    <div class="mt-4">
                        <h3 class="text-sm font-medium mb-2">Подсказки</h3>
                        <ul class="text-sm text-gray-600 space-y-1">
                            <li>— Один трек в строке. Пример: <code>RU123456789CN</code></li>
                            <li>— Можно загрузить файл .txt/.csv — одна строка = один трек.</li>
                            <li>— Перед отправкой откроется окно подтверждения с количеством треков.</li>
                        </ul>
                    </div>

                    <div class="mt-6 border-t pt-4 text-xs text-gray-500">
                        <div class="flex items-center justify-between">
                            <span>Статусы треков</span>
                            <a href="#" class="text-primary text-sm">Справка</a>
                        </div>
                        <div class="mt-3 grid grid-cols-3 gap-2">
                            <div class="flex items-center gap-2"><span class="w-3 h-3 bg-gray-300 rounded-full"></span><span class="text-xs">new</span></div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 bg-yellow-300 rounded-full"></span><span class="text-xs">in transit</span></div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 bg-green-300 rounded-full"></span><span class="text-xs">claimed</span></div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </main>
</div>

<!-- Модальное подтверждение -->
<div id="confirmModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-2xl w-11/12 sm:w-3/4 md:w-1/2 p-6">
        <h3 class="text-lg font-semibold mb-3">Подтверждение оформления</h3>
        <p class="text-sm text-gray-600 mb-4">Вы собираетесь оформить выдачу с <strong id="confirmCount">0</strong> треками в пункте: <strong id="confirmPickup"></strong>.</p>
        <div class="flex gap-3 justify-end">
            <button id="cancelModal" class="px-4 py-2 rounded-lg border border-gray-200">Отмена</button>
            <button id="submitModal" class="px-4 py-2 rounded-lg bg-primary text-white">Подтвердить и отправить</button>
        </div>
    </div>
</div>

<script>
/* UI behaviour: parse textarea, show preview, support file upload, copy/remove, confirmation modal */
(function() {
    const textarea = document.getElementById('track_codes');
    const fileInput = document.getElementById('fileInput');
    const previewList = document.getElementById('previewList');
    const previewEmpty = document.getElementById('previewEmpty');
    const codesCount = document.getElementById('codesCount');
    const clearBtn = document.getElementById('clearBtn');
    const openConfirmBtn = document.getElementById('openConfirmBtn');
    const confirmModal = document.getElementById('confirmModal');
    const cancelModal = document.getElementById('cancelModal');
    const submitModal = document.getElementById('submitModal');
    const confirmCount = document.getElementById('confirmCount');
    const confirmPickup = document.getElementById('confirmPickup');
    const form = document.getElementById('extraditionForm');
    const pickupPoint = document.getElementById('pickup_point');

    function parseCodes(text) {
        return text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }

    function renderPreview() {
        const codes = parseCodes(textarea.value);
        previewList.innerHTML = '';
        codesCount.textContent = codes.length;
        confirmCount.textContent = codes.length;
        if (codes.length === 0) {
            previewEmpty.classList.remove('hidden');
            previewList.classList.add('hidden');
            return;
        }
        previewEmpty.classList.add('hidden');
        previewList.classList.remove('hidden');

        codes.forEach((code, idx) => {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between gap-3 bg-gray-50 border border-gray-100 rounded-lg p-2';
            item.innerHTML = `
                <div class="min-w-0">
                    <div class="text-sm font-medium text-gray-800">${code}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" data-index="${idx}" class="copyBtn inline-flex items-center gap-2 px-3 py-1 text-sm border border-gray-200 rounded hover:bg-white">
                        <i class="ri-file-copy-line"></i> Копировать
                    </button>
                    <button type="button" data-index="${idx}" class="removeBtn inline-flex items-center gap-2 px-3 py-1 text-sm text-red-600 border border-red-100 rounded hover:bg-red-50">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            `;
            previewList.appendChild(item);
        });

        // attach handlers
        previewList.querySelectorAll('.copyBtn').forEach(btn => {
            btn.onclick = () => {
                const i = +btn.dataset.index;
                const codes = parseCodes(textarea.value);
                navigator.clipboard?.writeText(codes[i]).then(() => {
                    btn.innerHTML = '<i class="ri-check-line"></i> Скопировано';
                    setTimeout(() => btn.innerHTML = '<i class="ri-file-copy-line"></i> Копировать', 1200);
                }).catch(()=> {
                    alert('Не удалось скопировать в буфер обмена');
                });
            };
        });
        previewList.querySelectorAll('.removeBtn').forEach(btn => {
            btn.onclick = () => {
                const i = +btn.dataset.index;
                const codes = parseCodes(textarea.value);
                codes.splice(i, 1);
                textarea.value = codes.join('\\n');
                renderPreview();
            };
        });
    }

    textarea.addEventListener('input', renderPreview);

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            // строка -> заменить CRLF на \n и поставить в textarea
            const content = ev.target.result.replace(/\\r\\n/g, '\\n').trim();
            textarea.value = content;
            renderPreview();
        };
        reader.readAsText(file, 'utf-8');
        // очистить input чтобы можно было снова загрузить тот же файл
        fileInput.value = '';
    });

    clearBtn.addEventListener('click', () => {
        textarea.value = '';
        document.getElementById('comment').value = '';
        document.getElementById('receipt_id').value = '';
        document.getElementById('pickup_point').value = '';
        renderPreview();
    });

    openConfirmBtn.addEventListener('click', () => {
        const codes = parseCodes(textarea.value);
        if (codes.length === 0) {
            alert('Введите хотя бы один трек-код.');
            return;
        }
        if (!pickupPoint.value.trim()) {
            alert('Укажите пункт выдачи.');
            pickupPoint.focus();
            return;
        }
        confirmPickup.textContent = pickupPoint.value;
        confirmModal.classList.remove('hidden');
        confirmModal.classList.add('flex');
    });

    cancelModal.addEventListener('click', () => {
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
    });

    submitModal.addEventListener('click', () => {
        // просто отправляем форму
        form.submit();
    });

    // initial render (если сервер вернул данные)
    renderPreview();
})();
</script>

{% endblock %}

{% include 'includes/footer.html' %}
</body>
</html>
